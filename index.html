<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>连词成句练习</title>
<style>
    body {
        font-family: '楷体', sans-serif;
        background: linear-gradient(135deg, #f0f5f9 0%, #e0e8ed 100%);
        color: #333;
        padding: 30px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
    }
    h2 { text-align: center; color:#555;}
    textarea, input { width: 100%; padding: 10px; font-size:16px; margin-bottom:15px; border-radius:10px; border:1px solid #ccc;}
    button { background-color:#0099cc; color:white; border:none; padding:10px 20px; border-radius:10px; cursor:pointer; font-size:16px; margin:5px;}
    button:hover { background-color:#0077a3;}
    #qr { margin-top:15px;}
    #game-section { display:none; width:100%; max-width:600px; }
    #modules { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:15px;}
    .module { width:120px; height:50px; background:#f4f4f4; border-radius:10px; display:flex; justify-content:center; align-items:center; cursor:pointer; box-shadow:0 3px 6px rgba(0,0,0,0.1);}
    #words { display:flex; flex-wrap:wrap; gap:10px; justify-content:center;}
    .word { padding:10px 20px; border:1px solid #0099cc; border-radius:10px; cursor:pointer; background:#e6f2f7; color:#0099cc; font-weight:bold;}
    #finish-message { display:none; font-size:24px; color:#0099cc; margin-top:20px;}
</style>
</head>
<body>

<div id="input-section">
    <h2>老师端：输入句子生成练习</h2>
    <textarea id="sentences-input" placeholder="每句一句，空格拆词，至少10句"></textarea>
    <button id="generate-button">生成练习二维码</button>
    <div id="qr"></div>
</div>

<div id="game-section">
    <h2>学生端：连词成句练习</h2>
    <input type="text" id="student-name" placeholder="请输入姓名">
    <div id="modules"></div>
    <div id="words"></div>
    <button id="submit-btn" disabled>提交答案</button>
    <div id="finish-message">恭喜完成练习！</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
const inputSection = document.getElementById('input-section');
const gameSection = document.getElementById('game-section');
const sentencesInput = document.getElementById('sentences-input');
const generateButton = document.getElementById('generate-button');
const qrDiv = document.getElementById('qr');
const modulesDiv = document.getElementById('modules');
const wordsDiv = document.getElementById('words');
const submitBtn = document.getElementById('submit-btn');
const studentNameInput = document.getElementById('student-name');
const finishMessage = document.getElementById('finish-message');

let sentences = [];

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzB0hyTySOU0d97-3qBs0E8QqTS5vk2hhGdFieQYh0FrkENbqGx1eqm_ADAolGf9LWG/exec";

// ---------- 老师端生成二维码 ----------
generateButton.addEventListener('click', () => {
    const text = encodeURIComponent(sentencesInput.value.trim());
    if(!text){ alert('请输入句子'); return; }
    const exerciseURL = `${location.origin}${location.pathname}?data=${text}`;
    qrDiv.innerHTML = "";
    QRCode.toCanvas(exerciseURL, {width:200}, (err, canvas)=>{
        if(err){ console.error(err); return;}
        qrDiv.appendChild(canvas);
        alert('二维码生成完成，学生扫码进入练习。');
    });
});

// ---------- 学生端读取URL参数 ----------
function getQueryParam(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
}

const dataParam = getQueryParam('data');
if(dataParam){
    // 显示练习
    inputSection.style.display = 'none';
    gameSection.style.display = 'block';
    sentences = decodeURIComponent(dataParam).split('\n').filter(s=>s.trim()!=='');
    startGame();
}

// ---------- 游戏逻辑 ----------
let currentSentenceIndex = 0;

function startGame(){
    if(currentSentenceIndex >= sentences.length){
        gameSection.style.display = 'none';
        finishMessage.style.display = 'block';
        return;
    }
    modulesDiv.innerHTML = '';
    wordsDiv.innerHTML = '';
    submitBtn.disabled = true;

    const sentence = sentences[currentSentenceIndex].split(/\s+/).filter(w=>w.trim()!=='');
    const shuffled = sentence.slice().sort(()=>Math.random()-0.5);

    // 模块
    sentence.forEach(()=>{ 
        const m = document.createElement('div'); m.className='module'; modulesDiv.appendChild(m);
    });

    // 可拖动的单词
    shuffled.forEach(word=>{
        const w = document.createElement('div'); w.className='word'; w.textContent=word;
        w.addEventListener('click', ()=>{
            const empty = Array.from(modulesDiv.children).find(m=>m.textContent==='');
            if(empty){ empty.textContent = word; w.style.display='none'; checkAnswer(); }
        });
        wordsDiv.appendChild(w);
    });
}

// 检查答案是否填写完整
function checkAnswer(){
    const userWords = Array.from(modulesDiv.children).map(m=>m.textContent);
    submitBtn.disabled = userWords.includes('');
}

// ---------- 提交答案 ----------
submitBtn.addEventListener('click', ()=>{
    const name = studentNameInput.value.trim();
    if(!name){ alert('请输入姓名'); return; }

    const question = sentences[currentSentenceIndex];
    const correctAnswer = question.split(/\s+/).filter(w=>w.trim()!=='').join(' ');
    const studentAnswer = Array.from(modulesDiv.children).map(m=>m.textContent).join(' ');

    // POST 到 Google Apps Script
    fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({name, question, correctAnswer, studentAnswer})
    }).then(res=>res.json()).then(data=>{
        alert('提交成功');
        currentSentenceIndex++;
        if(currentSentenceIndex < sentences.length){
            startGame();
            studentNameInput.value = name; // 保持姓名
        }else{
            gameSection.style.display='none';
            finishMessage.style.display='block';
        }
    }).catch(err=>{console.error(err); alert('提交失败');});
});
</script>
</body>
</html>






