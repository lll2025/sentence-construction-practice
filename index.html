<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¿è¯æˆå¥ç»ƒä¹  - æ•™å¸ˆ+å­¦ç”Ÿæµ‹è¯•ç‰ˆ</title>
<style>
body { font-family: 'æ¥·ä½“', sans-serif; background: #f0f5f9; color: #333; margin: 0; padding: 20px; }
#teacher-section, #student-section { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
textarea { width: 100%; height: 150px; font-size: 16px; padding: 10px; border-radius: 10px; border: 1px solid #ccc; resize: none; box-sizing: border-box; }
button { padding: 10px 20px; border-radius: 10px; border: none; background: #0099cc; color: #fff; cursor: pointer; margin-top: 10px; font-size: 16px; }
button:hover { background: #0077a3; }
button:disabled { background: #ccc; cursor: not-allowed; }
#qrcode { margin-top: 20px; text-align: center; }
#modules, #words { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; min-height: 60px; }
.module, .word { padding: 10px 20px; border: 1px solid #0099cc; border-radius: 10px; cursor: pointer; background: #e6f2f7; font-weight: bold; font-size: 20px; min-height: 20px; display: flex; align-items: center; justify-content: center; }
.module:hover, .word:hover { background: #d0e8ed; }
.module { border: 2px dashed #0099cc; background: #f8f9fa; }
.module.filled { background: #e6f2f7; border: 1px solid #0099cc; }
#finish-message { display: none; color: #0099cc; font-size: 24px; text-align: center; margin-top: 20px; }
.student-info { margin-bottom: 20px; }
.student-info input { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
.progress { text-align: center; margin-bottom: 20px; font-size: 18px; color: #666; }
.instructions { background: #e8f4f8; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
</style>
</head>
<body>

<div id="teacher-section">
<h2>ğŸ“ æ•™å¸ˆè¾“å…¥é¢˜ç›®</h2>
<div class="instructions">
<p>ğŸ“ <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong></p>
<p>â€¢ æ¯è¡Œè¾“å…¥ä¸€ä¸ªå¥å­</p>
<p>â€¢ è¯è¯­ä¹‹é—´ç”¨ç©ºæ ¼åˆ†å¼€</p>
<p>â€¢ ä¾‹å¦‚ï¼šæˆ‘ çˆ± å­¦ä¹  ä¸­æ–‡</p>
</div>
<textarea id="teacher-sentences" placeholder="è¯·è¾“å…¥å¥å­ï¼Œæ¯è¡Œä¸€ä¸ªï¼š&#10;æˆ‘ çˆ± å­¦ä¹  ä¸­æ–‡&#10;ä»Šå¤© å¤©æ°” å¾ˆ å¥½&#10;æˆ‘ä»¬ ä¸€èµ· åš ä½œä¸š"></textarea>
<button id="generate-qrcode">ğŸ”— ç”Ÿæˆå­¦ç”Ÿç»ƒä¹ é“¾æ¥</button>
<button id="start-student-mode" style="display:none;">ğŸ‘¨â€ğŸ“ è¿›å…¥å­¦ç”Ÿç»ƒä¹ æ¨¡å¼</button>
<div id="qrcode"></div>
<div id="student-link" style="display:none; margin-top:10px;">
<p>ğŸ“± å­¦ç”Ÿå¯ä»¥ç‚¹å‡»ä¸‹æ–¹é“¾æ¥è¿›å…¥ç»ƒä¹ ï¼š</p>
<button id="direct-link" style="background:#28a745;">ç›´æ¥è¿›å…¥ç»ƒä¹ </button>
</div>
</div>

<div id="student-section" style="display:none;">
<h2>ğŸ‘¨â€ğŸ“ å­¦ç”Ÿç»ƒä¹ åŒº</h2>
<div class="student-info">
<label>ğŸ‘¤ å§“åï¼š<input type="text" id="student-name" placeholder="è¯·è¾“å…¥ä½ çš„å§“å"></label>
</div>
<div class="progress">
<span>ğŸ“Š è¿›åº¦ï¼šç¬¬ <span id="current-question">1</span> é¢˜ / å…± <span id="total-questions">0</span> é¢˜</span>
</div>
<div class="instructions">
<p>ğŸ¯ <strong>ç»ƒä¹ æ–¹æ³•ï¼š</strong>ç‚¹å‡»ä¸‹æ–¹çš„è¯è¯­ï¼Œå°†å®ƒä»¬æŒ‰æ­£ç¡®é¡ºåºæ”¾å…¥ä¸Šæ–¹çš„ç©ºæ ¼ä¸­</p>
</div>
<div id="modules"></div>
<div id="words"></div>
<div style="display:flex; justify-content:space-between; margin-top:20px;">
<button id="prev-button">â¬…ï¸ ä¸Šä¸€é¢˜</button>
<button id="next-button" disabled>ä¸‹ä¸€é¢˜ â¡ï¸</button>
</div>
<div id="finish-message">ğŸ‰ æ­å–œä½ ï¼Œç»ƒä¹ å®Œæˆï¼<br>ğŸ“Š ä½ çš„æˆç»©å·²ä¿å­˜</div>
</div>

<script>
const teacherSentences = document.getElementById('teacher-sentences');
const generateQRCodeBtn = document.getElementById('generate-qrcode');
const startStudentBtn = document.getElementById('start-student-mode');
const directLinkBtn = document.getElementById('direct-link');
const qrcodeDiv = document.getElementById('qrcode');
const studentLinkDiv = document.getElementById('student-link');
const teacherSection = document.getElementById('teacher-section');
const studentSection = document.getElementById('student-section');
const modulesDiv = document.getElementById('modules');
const wordsDiv = document.getElementById('words');
const nextButton = document.getElementById('next-button');
const prevButton = document.getElementById('prev-button');
const finishMessage = document.getElementById('finish-message');
const studentNameInput = document.getElementById('student-name');
const currentQuestionSpan = document.getElementById('current-question');
const totalQuestionsSpan = document.getElementById('total-questions');

let sentences = [];
let currentIndex = 0;
let studentAnswers = [];

// ç”Ÿæˆç»ƒä¹ é“¾æ¥
generateQRCodeBtn.addEventListener('click', () => {
    const inputText = teacherSentences.value.trim();
    if (!inputText) {
        alert('âš ï¸ è¯·å…ˆè¾“å…¥è‡³å°‘ä¸€ä¸ªå¥å­ï¼');
        return;
    }
    
    sentences = inputText.split('\n').filter(s => s.trim() !== '');
    if (sentences.length === 0) {
        alert('âš ï¸ è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæœ‰æ•ˆçš„å¥å­ï¼');
        return;
    }

    // å°†å¥å­æ•°æ®ç¼–ç åˆ°URLä¸­ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…åº”ç”¨ä¸­å»ºè®®ä½¿ç”¨æœåŠ¡å™¨ï¼‰
    const encodedSentences = encodeURIComponent(JSON.stringify(sentences));
    const studentUrl = window.location.origin + window.location.pathname + '?data=' + encodedSentences;
    
    // æ˜¾ç¤ºäºŒç»´ç ï¼ˆä½¿ç”¨ç®€åŒ–çš„æ–‡æœ¬äºŒç»´ç ï¼‰
    qrcodeDiv.innerHTML = `
        <div style="border: 2px solid #0099cc; padding: 20px; background: #f8f9fa; border-radius: 10px;">
            <p>ğŸ“± å­¦ç”Ÿç»ƒä¹ é“¾æ¥å·²ç”Ÿæˆï¼</p>
            <p style="font-size: 12px; word-break: break-all; background: white; padding: 10px; border-radius: 5px;">${studentUrl}</p>
            <p style="color: #666; font-size: 14px;">å­¦ç”Ÿå¯ä»¥å¤åˆ¶æ­¤é“¾æ¥åœ¨æ‰‹æœºæµè§ˆå™¨ä¸­æ‰“å¼€</p>
        </div>
    `;
    
    startStudentBtn.style.display = 'inline-block';
    studentLinkDiv.style.display = 'block';
    
    alert('âœ… ç»ƒä¹ é“¾æ¥å·²ç”Ÿæˆï¼å­¦ç”Ÿå¯ä»¥é€šè¿‡é“¾æ¥è¿›å…¥ç»ƒä¹ ã€‚');
});

// ç›´æ¥è¿›å…¥å­¦ç”Ÿæ¨¡å¼
directLinkBtn.addEventListener('click', () => {
    startStudentMode();
});

startStudentBtn.addEventListener('click', () => {
    startStudentMode();
});

function startStudentMode() {
    if (sentences.length === 0) {
        const inputText = teacherSentences.value.trim();
        if (!inputText) {
            alert('âš ï¸ è¯·å…ˆè¾“å…¥å¥å­ï¼');
            return;
        }
        sentences = inputText.split('\n').filter(s => s.trim() !== '');
    }
    
    teacherSection.style.display = 'none';
    studentSection.style.display = 'block';
    totalQuestionsSpan.textContent = sentences.length;
    currentIndex = 0;
    studentAnswers = [];
    startGame();
}

// è®¾ç½®Google Sheetsç›¸å…³å‡½æ•°
function toggleSheetsSetup() {
    const setupDiv = document.getElementById('google-sheets-setup');
    setupDiv.style.display = setupDiv.style.display === 'none' ? 'block' : 'none';
}

function setupGoogleSheets() {
    const url = document.getElementById('sheets-url').value.trim();
    if (!url) {
        alert('è¯·è¾“å…¥Google Apps Script URL');
        return;
    }
    
    // éªŒè¯URLæ ¼å¼
    if (!url.includes('script.google.com') && !url.includes('script.googleusercontent.com')) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„Google Apps Script URL');
        return;
    }
    
    GOOGLE_SHEETS_CONFIG.scriptUrl = url;
    GOOGLE_SHEETS_CONFIG.useLocalStorage = false;
    
    alert('âœ… Google Sheets è®¾ç½®æˆåŠŸï¼å­¦ç”Ÿå®Œæˆç»ƒä¹ åå°†è‡ªåŠ¨ä¿å­˜åˆ°æ‚¨çš„è¡¨æ ¼ã€‚');
    toggleSheetsSetup();
}

// åˆå§‹åŒ–æ—¶æ˜¾ç¤ºç°æœ‰æˆç»©æ•°é‡
window.addEventListener('load', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const practiceId = urlParams.get('id');
    const legacyData = urlParams.get('data');
    
    if (practiceId) {
        // æ–°çš„IDæ–¹å¼
        const practiceData = getPracticeData(practiceId);
        if (practiceData) {
            sentences = practiceData.sentences;
            startStudentMode();
        } else {
            alert('âŒ ç»ƒä¹ å·²è¿‡æœŸæˆ–ä¸å­˜åœ¨ï¼Œè¯·è”ç³»è€å¸ˆé‡æ–°ç”Ÿæˆé“¾æ¥ã€‚');
        }
    } else if (legacyData) {
        // å…¼å®¹æ—§çš„dataå‚æ•°æ–¹å¼
        try {
            sentences = JSON.parse(decodeURIComponent(legacyData));
            startStudentMode();
        } catch (e) {
            console.error('æ— æ³•è§£æç»ƒä¹ æ•°æ®:', e);
            alert('âŒ ç»ƒä¹ é“¾æ¥æ ¼å¼é”™è¯¯ï¼Œè¯·è”ç³»è€å¸ˆé‡æ–°ç”Ÿæˆé“¾æ¥ã€‚');
        }
    } else {
        // æ˜¾ç¤ºç°æœ‰æˆç»©æ•°é‡
        const allResults = JSON.parse(window.allResults || '[]');
        if (allResults.length > 0) {
            const viewBtn = document.getElementById('view-results');
            if (viewBtn) {
                viewBtn.textContent = `ğŸ“Š æŸ¥çœ‹æ‰€æœ‰æˆç»© (${allResults.length}æ¡)`;
            }
        }
    }
});

window.allResults = window.allResults || '[]';


function startGame() {
    if (currentIndex >= sentences.length) {
        finishGame();
        return;
    }
    
    const currentSentence = sentences[currentIndex].trim();
    const words = currentSentence.split(/\s+/).filter(w => w !== '');
    const shuffled = shuffle([...words]);
    
    currentQuestionSpan.textContent = currentIndex + 1;
    
    modulesDiv.innerHTML = '';
    wordsDiv.innerHTML = '';
    
    // åˆ›å»ºç­”é¢˜æ¨¡å—
    words.forEach(() => {
        const module = document.createElement('div');
        module.className = 'module';
        module.addEventListener('click', () => {
            if (module.textContent !== '') {
                const word = module.textContent;
                module.textContent = '';
                module.classList.remove('filled');
                
                // æ‰¾åˆ°å¯¹åº”çš„è¯è¯­æŒ‰é’®å¹¶æ˜¾ç¤º
                const wordButtons = Array.from(wordsDiv.children);
                const hiddenWord = wordButtons.find(w => w.textContent === word && w.style.display === 'none');
                if (hiddenWord) {
                    hiddenWord.style.display = '';
                }
                checkAnswer();
            }
        });
        modulesDiv.appendChild(module);
    });
    
    // åˆ›å»ºè¯è¯­æŒ‰é’®
    shuffled.forEach(word => {
        const wordButton = document.createElement('div');
        wordButton.className = 'word';
        wordButton.textContent = word;
        wordButton.addEventListener('click', () => {
            const emptyModule = Array.from(modulesDiv.children).find(m => m.textContent === '');
            if (emptyModule) {
                emptyModule.textContent = word;
                emptyModule.classList.add('filled');
                wordButton.style.display = 'none';
                checkAnswer();
            }
        });
        wordsDiv.appendChild(wordButton);
    });
    
    prevButton.disabled = currentIndex === 0;
    nextButton.disabled = true;
}

function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

function checkAnswer() {
    const correctWords = sentences[currentIndex].trim().split(/\s+/).filter(w => w !== '');
    const userWords = Array.from(modulesDiv.children).map(m => m.textContent);
    const allFilled = userWords.every(w => w !== '');
    
    if (!allFilled) {
        nextButton.disabled = true;
        return;
    }
    
    const correct = userWords.length === correctWords.length && 
                   userWords.every((w, i) => w === correctWords[i]);
    
    nextButton.disabled = !correct;
    
    if (correct) {
        nextButton.style.background = '#28a745';
        nextButton.textContent = 'âœ… æ­£ç¡®ï¼ä¸‹ä¸€é¢˜ â¡ï¸';
    } else {
        nextButton.style.background = '#dc3545';
        nextButton.textContent = 'âŒ å†è¯•è¯•';
        nextButton.disabled = false;
    }
}

nextButton.addEventListener('click', () => {
    // è®°å½•å­¦ç”Ÿç­”æ¡ˆ
    const userWords = Array.from(modulesDiv.children).map(m => m.textContent);
    const correctWords = sentences[currentIndex].trim().split(/\s+/).filter(w => w !== '');
    const isCorrect = userWords.every((w, i) => w === correctWords[i]);
    
    studentAnswers.push({
        questionIndex: currentIndex,
        question: sentences[currentIndex],
        userAnswer: userWords.join(' '),
        correctAnswer: correctWords.join(' '),
        isCorrect: isCorrect,
        timestamp: new Date().toISOString()
    });
    
    currentIndex++;
    nextButton.style.background = '#0099cc';
    nextButton.textContent = 'ä¸‹ä¸€é¢˜ â¡ï¸';
    startGame();
});

prevButton.addEventListener('click', () => {
    if (currentIndex > 0) {
        currentIndex--;
        startGame();
    }
});

function finishGame() {
    studentSection.style.display = 'none';
    finishMessage.style.display = 'block';
    
    // ä¿å­˜å­¦ç”Ÿæˆç»©ï¼ˆè¿™é‡Œä½¿ç”¨consoleè¾“å‡ºï¼Œå®é™…åº”ç”¨ä¸­å¯ä»¥å‘é€åˆ°æœåŠ¡å™¨ï¼‰
    const studentName = studentNameInput.value || 'æœªå¡«å†™å§“å';
    const totalQuestions = sentences.length;
    const correctAnswers = studentAnswers.filter(a => a.isCorrect).length;
    const score = Math.round((correctAnswers / totalQuestions) * 100);
    
    const result = {
        studentName: studentName,
        totalQuestions: totalQuestions,
        correctAnswers: correctAnswers,
        score: score,
        completedAt: new Date().toISOString(),
        answers: studentAnswers
    };
    
    console.log('å­¦ç”Ÿæˆç»©ï¼š', result);
    
    // æ˜¾ç¤ºæˆç»©
    finishMessage.innerHTML = `
        ğŸ‰ æ­å–œ ${studentName}ï¼Œç»ƒä¹ å®Œæˆï¼<br>
        ğŸ“Š æˆç»©ï¼š${correctAnswers}/${totalQuestions} (${score}åˆ†)<br>
        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #0099cc; color: white; border: none; border-radius: 5px; cursor: pointer;">
            ğŸ”„ é‡æ–°å¼€å§‹ç»ƒä¹ 
        </button>
    `;
    
    // TODO: è¿™é‡Œå¯ä»¥æ·»åŠ å°†æˆç»©å‘é€åˆ°Google Sheetsæˆ–å…¶ä»–æ•°æ®å­˜å‚¨çš„ä»£ç 
    alert(`ğŸ‰ ç»ƒä¹ å®Œæˆï¼\nğŸ‘¤ å­¦ç”Ÿï¼š${studentName}\nğŸ“Š æˆç»©ï¼š${correctAnswers}/${totalQuestions} (${score}åˆ†)`);
}
</script>
</body>
</html>




