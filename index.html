<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>连词成句练习</title>
<style>
body {
    font-family: '楷体', sans-serif;
    background: linear-gradient(135deg, #f0f5f9 0%, #e0e8ed 100%);
    color: #333;
    padding: 30px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    margin: 0;
}
#input-section, #qrcode-section, #student-section, #game-section {
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 20px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    padding: 30px;
    width: 90%;
    max-width: 600px;
    margin-bottom: 30px;
}
textarea { width: 100%; height: 200px; border-radius:10px; padding:15px; font-size:16px; }
button { background-color: #0099cc; color:white; border:none; border-radius:10px; padding:12px 25px; font-size:16px; cursor:pointer; margin-top:10px; }
button:hover { background-color:#0077a3; }
#modules { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; justify-content:center; }
.module { width:120px; height:50px; border-radius:10px; display:flex; align-items:center; justify-content:center; background:#f4f4f4; cursor:pointer; box-shadow:0 5px 10px rgba(0,0,0,0.1); font-size:18px; }
.module:hover { background:#eaeaea; }
#words { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
.word { padding:10px 20px; border:1px solid #0099cc; border-radius:10px; cursor:grab; background-color:#e6f2f7; color:#0099cc; font-weight:bold; font-size:20px; }
.word:hover { background-color:#d0e8ed; }
#finish-message { display:none; font-size:28px; font-weight:bold; color:#0099cc; text-align:center; margin-bottom:20px; }
</style>
</head>
<body>

<!-- 老师输入区域 -->
<div id="input-section">
    <h2>老师输入句子</h2>
    <textarea id="sentences-input" placeholder="每行一个句子，每个词用空格隔开"></textarea>
    <button id="generate-btn">生成二维码</button>
</div>

<!-- 二维码区域 -->
<div id="qrcode-section" style="display:none;">
    <h2>二维码</h2>
    <div id="qrcode"></div>
</div>

<!-- 学生输入姓名 -->
<div id="student-section" style="display:none;">
    <h2>请输入姓名</h2>
    <input type="text" id="student-name" placeholder="学生姓名" style="width:80%;padding:10px;font-size:16px;">
    <button id="start-btn">开始练习</button>
</div>

<!-- 游戏区 -->
<div id="game-section" style="display:none;">
    <div id="modules"></div>
    <div id="words"></div>
    <div style="display:flex; justify-content:space-between; margin-top:20px;">
        <button id="prev-btn">上一个</button>
        <button id="next-btn" disabled>下一个</button>
    </div>
</div>

<div id="finish-message">恭喜你，练习完成！</div>

<!-- QRCode.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
const teacherInput = document.getElementById('sentences-input');
const generateBtn = document.getElementById('generate-btn');
const qrcodeDiv = document.getElementById('qrcode');
const qrcodeSection = document.getElementById('qrcode-section');

const studentSection = document.getElementById('student-section');
const studentNameInput = document.getElementById('student-name');
const startBtn = document.getElementById('start-btn');

const gameSection = document.getElementById('game-section');
const modulesDiv = document.getElementById('modules');
const wordsDiv = document.getElementById('words');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const finishMessage = document.getElementById('finish-message');

let sentences = [];
let currentSentenceIndex = 0;
let studentName = '';
let studentAnswers = [];

const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzB0hyTySOU0d97-3qBs0E8QqTS5vk2hhGdFieQYh0FrkENbqGx1eqm_ADAolGf9LWG/exec";

// 生成二维码（老师端）
generateBtn.addEventListener('click', ()=>{
    const input = teacherInput.value.trim();
    if(!input){ alert('请输入句子'); return; }
    sentences = input.split('\n').filter(s=>s.trim()!=='');
    const encoded = btoa(JSON.stringify(sentences));
    const url = window.location.origin + window.location.pathname + '?role=student&data=' + encoded;
    qrcodeDiv.innerHTML = '';
    new QRCode(qrcodeDiv, {text:url,width:200,height:200,colorDark:"#000000",colorLight:"#ffffff"});
    qrcodeSection.style.display='block';
});

// 解析学生端
function getQueryVariable(variable){
    const query = window.location.search.substring(1);
    const vars = query.split("&");
    for(let i=0;i<vars.length;i++){
        const pair = vars[i].split("=");
        if(pair[0] == variable){ return decodeURIComponent(pair[1]); }
    }
    return null;
}

window.onload = ()=>{
    const role = getQueryVariable('role');
    const data = getQueryVariable('data');
    if(role==='student' && data){
        sentences = JSON.parse(atob(data));
        document.getElementById('input-section').style.display='none';
        qrcodeSection.style.display='none';
        studentSection.style.display='block';
    }
};

// 学生输入姓名后开始
startBtn.addEventListener('click', ()=>{
    studentName = studentNameInput.value.trim();
    if(!studentName){ alert('请输入姓名'); return; }
    studentSection.style.display='none';
    gameSection.style.display='block';
    currentSentenceIndex=0;
    studentAnswers=[];
    startGame();
});

// 游戏逻辑（最早版本练习方式）
function startGame(){
    if(currentSentenceIndex >= sentences.length){
        gameSection.style.display='none';
        finishMessage.style.display='block';
        submitAnswers();
        return;
    }
    const currentSentence = sentences[currentSentenceIndex];
    const words = currentSentence.split(/\s+/).filter(w=>w.trim()!=='');
    const shuffled = shuffleArray([...words]);

    modulesDiv.innerHTML='';
    wordsDiv.innerHTML='';

    words.forEach(()=>{ 
        const m = document.createElement('div'); m.className='module'; modulesDiv.appendChild(m); 
    });

    shuffled.forEach(word=>{
        const w = document.createElement('div'); w.className='word'; w.textContent=word; 
        w.id = `word-${Math.random().toString(36).substr(2,9)}`;
        w.draggable=true;
        w.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text', w.id); });
        w.addEventListener('click', ()=>{
            const emptyModule = Array.from(modulesDiv.children).find(m=>m.textContent==='');
            if(emptyModule){ emptyModule.textContent = word; w.style.display='none'; checkAnswer(); }
        });
        wordsDiv.appendChild(w);
    });

    modulesDiv.querySelectorAll('.module').forEach(m=>{
        m.addEventListener('dragover', e=>e.preventDefault());
        m.addEventListener('drop', e=>{
            e.preventDefault();
            const data = e.dataTransfer.getData('text');
            const el = document.getElementById(data);
            if(el){ m.textContent=el.textContent; el.style.display='none'; checkAnswer(); }
        });
        m.addEventListener('click', ()=>{
            if(m.textContent!==''){
                const word = m.textContent; m.textContent='';
                const hiddenWord = Array.from(wordsDiv.children).find(w=>w.textContent===word && w.style.display==='none');
                if(hiddenWord) hiddenWord.style.display='';
                checkAnswer();
            }
        });
    });

    prevBtn.disabled = currentSentenceIndex===0;
    nextBtn.disabled=true;
}

function checkAnswer(){
    const currentSentence = sentences[currentSentenceIndex];
    const correct = currentSentence.split(/\s+/).filter(w=>w.trim()!=='');
    const user = Array.from(modulesDiv.children).map(m=>m.textContent);
    const allFilled = user.every(u=>u!=='');
    nextBtn.disabled=!allFilled;
}

nextBtn.addEventListener('click', ()=>{
    const currentSentence = sentences[currentSentenceIndex];
    const correct = currentSentence.split(/\s+/).filter(w=>w.trim()!=='');
    const user = Array.from(modulesDiv.children).map(m=>m.textContent);
    studentAnswers.push(user.join(' '));
    currentSentenceIndex++;
    startGame();
});

prevBtn.addEventListener('click', ()=>{
    if(currentSentenceIndex>0){ currentSentenceIndex--; startGame(); }
});

function shuffleArray(arr){
    for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
}

function submitAnswers(){
    const payload = {
        name: studentName,
        answers: studentAnswers,
        questions: sentences
    };
    fetch(GOOGLE_SCRIPT_URL,{
        method:'POST',
        mode:'no-cors',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
    });
}
</script>
</body>
</html>





